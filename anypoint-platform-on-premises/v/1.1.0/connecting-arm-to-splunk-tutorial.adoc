= Connecting ARM to Splunk Tutorial
keywords: analytics, monitoring, splunk, mule events, logging, api analytics, metrics, traceability, arm, anypoint runtime manager

This document walks you through the integration of ARM On-Premise Edition with Splunk in order to send business events and API Analytics.

In order to provide a real life demo, this demo uses an existing RAML based API for creating orders to buy products that also contains an API proxy, which will then be used to extract analytics.

The following diagram is an overview on the entire API Led Demo:

image:arm_tutorial_big_picture.png[ARM Tutorial Big Picture]

== API Led Demo Summary

This demo shows an order system that follows an API Led approach. This system is modeled to allow a user to create orders using a mobile application (or emulator) and query the status of previously created orders.
When creating an order, the user needs to complete a form and, depending on the values of those fields, different business flows are called.
The most important field among these is the country:

* *country = United States* implies that once the order is placed, a message in a queue is created for all the listeners to consume it.
* *country = Other* implies that the order is merely logged.

Below is the demo's main flow:

image:arm_tutorial_full_flow.png[full flow]

The main objective of this demo is to show how Business Events – both default and custom events – can be monitored and consumed using Splunk. Business events are created when:
* a new order is placed
** if the country is `United States`, another additional event gets created, confirming that the message was put into the queue.
* an existing order is queried to get the status

== Environment Configuration

Since this demo uses an on premises ESB, a Windows AWS instance needs to be created on the ESB where the demo application is running.

All the information about hosts and users is listed below:

* *AWS Instance*
** host: 54.209.14.145:443
** user: msps
** pass: Anypoint1357!
* *Staging ARM*
** host: https://anypoint.mulesoft.com/
** user: arm-demo
** pass: Mule1379
* *Splunk instance*
** host: https://ec2-52-88-188-182.us-west-2.compute.amazonaws.com
** user: admin
** pass: Muleftw1!

== How to Run the Demo

This demo can be used to show that you can integrate your on-premise systems (like Splunk, ELK or any other third party systems) to consume information produced by Mule such as Business Events, API analytics, logs, etc.

The demo consists on:

. Running the business use case
. Running the integration section
.. Business events: show business events integration with Splunk
.. Analytics: show API analytics events integration with Splunk.
. Running the agent configuration section.



=== Running the business use case

. Connect to the AWS instance using Remote Desktop
+
image:arm_demo_remote_desktop.png[remote desktop]

. Open the iPhone Simulator on using the link on the Desktop, scroll to the bottom and select ‘Create an order'.

+
image:arm_tutorial_emulator.png[emulator]

. Enter the required values:
.. first and and last name
.. address: must contain at least 10 characters and a number.
.. email: should be your email in order to get notified
.. products: chose any products
.. country: choose united states
+
image:arm_tutorial_emulator_form.png[emulator]

. Scroll down and create the order. When the order gets created, a business event containing the *order id* and the *count* gets generated and pushed to Splunk.
. Click on the order you just created in order to check the order status. Once again, a business event is created and pushed to Splunk. This concludes the business use case.

== Business Events Integration

. You can now enter the Splunk account and see the business events that these actions genrated represented there. A report is already provided to show both default business events per integration flow and custom business events generated by the user.
.. You can see this report in Splunk through link:http://ec2-52-88-188-182.us-west-2.compute.amazonaws.com/en-US/app/search/demo__business_events_dashboard?earliest=0&latest=[this url]. The report looks like this:
+
image:arm_tutorial_activity.png[activity]
. If you click on any of the events, you can see all of the information linked to it. Below are two examples:
+
image:arm_tutorial_event1.png[event]
+
image:arm_tutorial_event2.png[event]

. Keep in mind that this is just a sample of all the information that you can push to Splunk. Other useful information, like server metrics, could be imported as well by using link:http://blogs.mulesoft.com/dev/mule-dev/intro-mule-agent-architecture/[other internal handlers] such as JMX.

== Gateway Analytics Integration

Before you can send API Analytics data to Splunk, you must configure your API Gateway installation accordingly. To do so, follow the steps in link:/runtime-manager/sending-data-from-arm-to-external-monitoring-software#configure-api-analytics[Configure API Gateway].

== Agent Configuration

An important part of this demo is to show how the integration must be setup. All that needs to be done to achieve this is to configure the link:/mule-agent/v/1.3.0/index[The Mule Agent] to use the Splunk Internal Handler to push information into Splunk.
The handler configuration for both Business Events or Analytics, can be configured through the ARM UI. Here are the steps to do this:

. Login to ARM using the provided credentials.
. Click on the Servers tab to see all the servers – both with ESB and API Gateway runtimes – currently managed by ARM
. Click on the `arm-demo-gateway` server, as this is the only one that runs on the API Gateway, the server details page will then display on the right:
+
image:arm_ui_activate_agent.png[agent]
. There are two tabs on this menu: Applications and Agent Plugins. Click on `Agent Plugins` to see the following configuration menu:
+
image:arm_ui_splunk_api.png[agent]

. From this menu, you can configure all of the plugins for the agent. If you've changed any fields, ARM updates your local instance of API Gateway (or ESB) using the Agent Rest API.
. Click on the Splunk Plugin to see its configuration parameters.
+
[TIP]
You could also configure ELK in the same way as is shown for Splunk in this tutorial.

. Once you click on the configuration button, you can modify any of the parameters on the Splunk plugin, like: user credentials, indexes, etc.
+
image:arm_ui_configure_splunk.png[agent]
.You can also manage the agent configuration at a cluster level, this configuration would then be replicated automatically to all of its nodes.

[NOTE]
====
While setting the agent configuration via the ARM UI, this simply composes a YAML file like the one shown below:

[source,yaml,linenums]
----
transports:
  rest.agent.transport:
	enabled: true
	port: 9997
services:
  mule.agent.tracking.service:
	globalTrackingLevel: DEBUG
internalHandlers:
  domaindeploymentnotification.internal.message.handler:
	enabled: true
  applicationdeploymentnotification.internal.message.handler:
	enabled: true
  mule.agent.tracking.handler.log:
	enabled: true
	fileName: /var/log/mule/agent/mule-event-tracking.log
	filePattern: /var/log/mule/agent/mule-event-tracking-%d{yyyy-dd-MM}-%i.log
  mule.agent.tracking.handler.splunk:
	enabled: 'true'
	scheme: https
	host: ec2-52-88-188-182.us-west-2.compute.amazonaws.com
	user: xxx
	pass: xxxx
	splunkSource: mule-event-tracking-demo
----

====
